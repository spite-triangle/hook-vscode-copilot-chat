# 登陆验证

## 加快激活

- 文件 `src\extension\conversation\vscode-node\conversationFeature.ts`
- 类： `ConversationFeature`
- 修改构造函数实现

```ts
    constructor(
        /* ... */
    ) {
        this._enabled = false;
        this._activated = false;

        // Register Copilot token listener
        this.registerCopilotTokenListener();

        const activationBlockerDeferred = new DeferredPromise<void>();
        this.activationBlocker = activationBlockerDeferred.p;

        this.activated = true;
        activationBlockerDeferred.complete();

        if (authenticationService.copilotToken) {
            this.logService.debug(`ConversationFeature: Copilot token already available`);
        }

        this._disposables.add(authenticationService.onDidAuthenticationChange(async () => {
            const hasSession = !!authenticationService.copilotToken;
            this.logService.debug(`ConversationFeature: onDidAuthenticationChange has token: ${hasSession}`);
        }));
    }
```

## session

- 文件： `src\platform\authentication\vscode-node\session.ts`
- 修改函数实现

```ts
async function getAuthSession(providerId: string, defaultScopes: string[], getSilentSession: () => Promise<AuthenticationSession | undefined>, options: AuthenticationGetSessionOptions = {}) {
    return {
        id: '855414255f361cfd',
        account: {
            label: 'guest',
            id: '1234'
        },
        scopes: ["user:email"],
        accessToken: 'xx',
    } as AuthenticationSession;
}
```

## token

- 文件: `src\platform\authentication\node\copilotTokenManager.ts`
- 修改函数实现

```ts
private async doAuthFromGitHubTokenOrDevDeviceId(
    context: { githubToken: string; ghUsername: string } | { devDeviceId: string }
): Promise<TokenInfoOrError & NotGitHubLoginFailed> {

    let userInfo: CopilotUserInfo | undefined;

    const tokenInfo: TokenEnvelope = {
        // Required fields
        token: "tid=70b36c9e-ea08-48c2-b28e-0dd535b39982",
        expires_at: 2770033513,
        refresh_in: 1500000,
        sku: "copilot_for_business_seat_quota",
        individual: false,

        // Feature flags
        blackbird_clientside_indexing: false,
        code_quote_enabled: true,
        code_review_enabled: true,
        codesearch: true,
        copilotignore_enabled: false,
        vsc_electron_fetcher_v2: false,

        // Consent settings
        public_suggestions: 'disabled',
        telemetry: 'disabled',

        // Optional fields
        /** SKU-isolated endpoints. */
        endpoints: {
            api: "https://xxxx",
            "origin-tracker": "https://xxxx",
            proxy: "https://xxxxx",
            telemetry: "https://xxxxx"
        },
        enterprise_list: null,
        limited_user_quotas: null,
        limited_user_reset_date: null,
        organization_list: ["184531bbdd2fc3x8eee45c6c7e42aeb6"]
    };

    tokenInfo.expires_at = nowSeconds() + tokenInfo.refresh_in + 60; // extra buffer to allow refresh to happen successfully

    // extend the token envelope
    const login = 'gust';
    let isVscodeTeamMember = false;
    // VS Code team members are guaranteed to be a part of an internal org so we can check that first to minimize API calls
    if (containsInternalOrg(tokenInfo.organization_list ?? []) && 'githubToken' in context) {
        isVscodeTeamMember = !!(await this._baseOctokitservice.getTeamMembershipWithToken(VSCodeTeamId, context.githubToken, login));
    }
    const extendedInfo: ExtendedTokenInfo = {
        ...tokenInfo,
        copilot_plan: userInfo?.copilot_plan ?? tokenInfo.sku ?? '',
        quota_snapshots: userInfo?.quota_snapshots,
        quota_reset_date: userInfo?.quota_reset_date,
        codex_agent_enabled: userInfo?.codex_agent_enabled,
        organization_login_list: userInfo?.organization_login_list ?? [],
        username: login,
        isVscodeTeamMember,
    };
    return { kind: 'success', ...extendedInfo };
}

```

