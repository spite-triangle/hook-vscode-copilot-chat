# 终端

## 命令行提示词调整

- 位置： `src\extension\conversation\vscode-node\terminalFixGenerator.ts`
- 类：`TerminalQuickFixGenerator`
- 修改：对 `prompt.messages` 中的元素顺序进行调整

```ts
	async generateTerminalQuickFix(commandMatchResult: vscode.TerminalCommandMatchResult, token: CancellationToken): Promise<ICommandSuggestion[] | undefined> {
		/* ... */

		const promptRenderer = PromptRenderer.create(this._instantiationService, endpoint, TerminalQuickFixPrompt, {
			commandLine: commandMatchResult.commandLine,
			output: [],
			verifiedContextUris,
			verifiedContextDirectoryUris,
			nonExistentContextUris,
		});

		const prompt = await promptRenderer.render(undefined, undefined);

        // NOTE - 调整提示词顺序
		const mapMessages = new Map<Raw.ChatRole, Raw.ChatMessage>();
		for (var i = 0; i < prompt.messages.length; i++) {
			const item = prompt.messages[i];

			if (mapMessages.has(item.role) === false) {
				mapMessages.set(item.role, item);
			} else {
				const origin = mapMessages.get(item.role)!;

				const lastContent = origin.content.at(-1);
				const nextContent = item.content.at(0);
				if (lastContent && nextContent && lastContent.type === Raw.ChatCompletionContentPartKind.Text && nextContent.type === Raw.ChatCompletionContentPartKind.Text) {
					lastContent.text = lastContent.text.trimEnd() + '\n' + nextContent.text;
					origin.content = origin.content.concat(item.content.slice(1));
				} else {
					origin.content.push(toTextPart('\n'));
					origin.content = origin.content.concat(item.content);
				}
			}
		}

		prompt.messages.splice(0, prompt.messages.length);
		for (let item of mapMessages.values()) {
			prompt.messages.push(item);
		}

		/* ... */
	}
```

- 位置： `src\extension\conversation\vscode-node\terminalFixGenerator.ts`
- 类：`TerminalQuickFixGenerator`
- 修改：对 `prompt.messages` 中的元素顺序进行调整

```ts
	private async _generateTerminalQuickFixFileContext(commandMatchResult: vscode.TerminalCommandMatchResult, token: CancellationToken) {

		/* ... */

		const prompt = await promptRenderer.render(undefined, undefined);
		this._logService.debug('_generalTerminalQuickFixFileContext prompt.messages: ' + prompt.messages);

        // NOTE - 调整提示词顺序
		const mapMessages = new Map<Raw.ChatRole, Raw.ChatMessage>();
		for (var i = 0; i < prompt.messages.length; i++) {
			const item = prompt.messages[i];

			if (mapMessages.has(item.role) === false) {
				mapMessages.set(item.role, item);
			} else {
				const origin = mapMessages.get(item.role)!;

				const lastContent = origin.content.at(-1);
				const nextContent = item.content.at(0);
				if (lastContent && nextContent && lastContent.type === Raw.ChatCompletionContentPartKind.Text && nextContent.type === Raw.ChatCompletionContentPartKind.Text) {
					lastContent.text = lastContent.text.trimEnd() + '\n' + nextContent.text;
					origin.content = origin.content.concat(item.content.slice(1));
				} else {
					origin.content.push(toTextPart('\n'));
					origin.content = origin.content.concat(item.content);
				}
			}
		}

		prompt.messages.splice(0, prompt.messages.length);
		for (let item of mapMessages.values()) {
			prompt.messages.push(item);
		}

		/* ... */
	}
```